context("Basic calculations")

bf <- function(data_model, h1_model, h0_model) {
  lik <- do.call(bayesplay::likelihood, data_model)
  h1 <- do.call(bayesplay::prior, h1_model)
  h0 <- do.call(bayesplay::prior, h0_model)
  m1 <- integral(lik * h1)
  m0 <- integral(lik * h0)
  unclass(m1 / m0)
}

test_cases <- tibble::tribble(
  ~data_model, ~h1_model, ~h0_model, ~result, ~label,
  list(family = "normal", mean = 5, sd = 10),
  list(family = "uniform", min = 0, max = 20),
  list(family = "point", point = 0),
  0.89,
  "uniform prior",
  list(family = "normal", mean = 5.5, sd = 32.35),
  list(family = "normal", mean = 0, sd = 13.3, range = c(0, Inf)),
  list(family = "point", point = 0),
  0.97,
  "normal prior",
  list(family = "normal", mean = 0.63, sd = 0.43),
  list(family = "normal", mean = 0, sd = 2.69, range = c(0, Inf)),
  list(family = "point", point = 0),
  0.83,
  "half-normal prior",
  list(family = "normal", mean = 15, sd = 13),
  list(family = "normal", mean = 50, sd = 14),
  list(family = "point", point = 0),
  0.25,
  "normal prior",
  list("student_t", mean = 5.47, sd = 32.2, df = 119),
  list("student_t", mean = 13.3, sd = 4.93, df = 72),
  list("point", 0),
  0.97,
  "student_t prior (student_t likelihood)",
  list(family = "noncentral_t", t = (0.8880938 / 0.5952841) * sqrt(10), df = 9),
  list(family = "cauchy", location = 0, scale = 1 * sqrt(10)),
  list(family = "point", point = 0),
  42.44814,
  "against bayesfactor package",
  list(family = "noncentral_d", d = (0.8880938 / 0.5952841), n = 10),
  list(family = "cauchy", 0, 1),
  list(family = "point", point = 0),
  42.44814,
  "one-sample default t-test (on cohen's d)",
  list(family = "noncentral_t", t = -0.498711932866233, df = 33),
  list(family = "cauchy", location = 0, scale = 2.95683228182749),
  list(family = "point", point = 0),
  0.274111,
  "one-sample default t-test (on t-stat)",
  list(family = "noncentral_d2", d = -0.168664261389219, n1 = 17, n2 = 18),
  list(family = "cauchy", location = 0, scale = 1),
  list(family = "point", point = 0),
  0.274111,
  "independent samples default t (on cohen's d)",
  list(family = "noncentral_d", d = 0.226960899716229, n = 80),
  list(family = "cauchy", scale = 1),
  list(family = "point", point = 0),
  1 / 1.557447,
  "default bayes t (orginal)",
  list(family = "noncentral_d", d = 0.226960899716229, n = 80),
  list(family = "cauchy", scale = 1, range = c(0, Inf)),
  list(family = "point", 0),
  1 / 0.79745,
  "default bayes t (orginal) one-sided",
  list(family = "noncentral_t", t = 2.03, df = 79),
  list(family = "cauchy", scale = 1 * sqrt(80)),
  list(family = "point", 0),
  1 / 1.557447,
  "default bayes t (t version)",
  list(family = "binomial", 3, 12),
  list(family = "beta", alpha = 1, beta = 2),
  list(family = "point", point = 0.5),
  1 / 0.4887695,
  "binomial likelihood, beta prior",
  list(family = "binomial", 3, 12),
  list(family = "uniform", min = 0, max = 1),
  list(family = "point", point = 0.5),
  1 / 0.6982422,
  "binomial likelihood, uniform prior",
  list(family = "binomial", 3, 12),
  list(family = "beta", 1, 1),
  list(family = "point", point = 0.5),
  1 / 0.6982422,
  "binomial likelihood, beta uniform",
  list(family = "binomial", successes = 2, trials = 10),
  list(family = "beta", alpha = 1, beta = 2.5),
  list(family = "point", point = 0.5),
  3.3921325,
  "binomial likelihood, beta prior",
  list("noncentral_t", 4.46, 50),
  list("cauchy", 0, 1 * sqrt(51)),
  list("point", 0),
  410.7568,
  "anomalous t test v1 (as t)",
  list("noncentral_d", 0.624524917476492, 51),
  list("cauchy", 0, .707),
  list("point", 0),
  460.2497,
  "previously anomalous t test v2 (as d)",
  list("noncentral_t", 4.46, 50),
  list("cauchy", 0, 0.707 * sqrt(51)),
  list("point", 0),
  460.2497,
  "previously anomalous t test v2 (as t)",
)

patrick::with_parameters_test_that(
  "Basic calculations", {
    testthat::expect_equal(
      bf(data_model, h1_model, h0_model),
      result,
      tolerance = 0.005,
      scale = 1,
      label = label
    )
  },
  .cases = test_cases
)
